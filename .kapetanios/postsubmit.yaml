version: v1
kind: Build
spec:
  postsubmits:
  - name: publish-linux-binaries
    timeout: 15m
    machine:
      resource: medium
    skipBranches:
      - "*"
    steps:
    - description: Build piped
      runner: gcr.io/pipecd/runner:1.0.0
      commands:
        - bazelisk --output_base=/workspace/bazel_out build --config=ci --config=linux --config=stamping //:copy_piped
        - bazelisk --output_base=/workspace/bazel_out build --config=ci --config=linux --config=stamping //:copy_pipectl
      secrets:
      - name: bazel_cache_service_account
        type: PROJECT
    - description: Publish piped
      runner: gcr.io/pipecd/asset-publisher:0.2.0
      commands:
        - /asset-publisher --org=pipe-cd --repo=pipecd --asset-name-suffix=linux_amd64 --asset-file=bazel-bin/piped
        - /asset-publisher --org=pipe-cd --repo=pipecd --asset-name-suffix=linux_amd64 --asset-file=bazel-bin/pipectl
      secrets:
      - name: github_token
        type: PROJECT

  - name: publish-darwin-binaries
    timeout: 30m
    machine:
      resource: medium
    skipBranches:
      - "*"
    steps:
    - description: Build piped
      runner: gcr.io/pipecd/runner:1.0.0
      commands:
        - bazelisk --output_base=/workspace/bazel_out build --config=ci --config=darwin --config=stamping //:copy_piped
        - bazelisk --output_base=/workspace/bazel_out build --config=ci --config=darwin --config=stamping //:copy_pipectl
      secrets:
      - name: bazel_cache_service_account
        type: PROJECT
    - description: Publish piped
      runner: gcr.io/pipecd/asset-publisher:0.2.0
      commands:
        - /asset-publisher --org=pipe-cd --repo=pipecd --asset-name-suffix=darwin_amd64 --asset-file=bazel-bin/piped
        - /asset-publisher --org=pipe-cd --repo=pipecd --asset-name-suffix=darwin_amd64 --asset-file=bazel-bin/pipectl
      secrets:
      - name: github_token
        type: PROJECT
