version: v1
kind: Build
spec:
  presubmits:
  - name: build
    timeout: 15m
    machine:
      resource: medium
    steps:
    - description: Build all services
      runner: gcr.io/pipecd/runner:1.0.0
      commands:
        - bazelisk --output_base=/workspace/bazel_out build --config=ci --config=linux //...
      secrets:
      - name: bazel_cache_service_account
        type: PROJECT

  - name: test
    timeout: 15m
    machine:
      resource: large
    steps:
    - description: Run all tests
      runner: gcr.io/pipecd/runner:1.0.0
      commands:
        - bazelisk --output_base=/workspace/bazel_out test --config=ci --config=linux //pkg/...
      secrets:
      - name: bazel_cache_service_account
        type: PROJECT

    - description: Run coverage for unit tests
      runner: gcr.io/pipecd/runner:1.0.0
      commands:
        - bazelisk --output_base=/workspace/bazel_out coverage --config=ci --config=linux -- //pkg/...
      secrets:
      - name: bazel_cache_service_account
        type: PROJECT

    - name: collect-coverage
      description: Collect coverage profiles
      runner: kapetanios@collect-go-cover-profiles
      params:
        - root-path=bazel-testlogs
        - profile-matcher="**/coverage.dat"
        - source-exclude-matcher="**/*.mock.go,**/*.pb.go,**/*.validate.go,**/*.embed.go,**/*.deepcopy.go"
        - base-import-path=github.com/pipe-cd/pipecd

  - name: integration-test
    timeout: 15m
    machine:
      resource: large
    steps:
    - description: Run all integration tests
      runner: gcr.io/pipecd/runner-integration:1.0.0
      commands:
        - bazelisk --output_base=/workspace/bazel_out test --config=ci --config=linux //test/integration/...
      secrets:
      - name: bazel_cache_service_account
        type: PROJECT
