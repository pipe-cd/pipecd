# This workflow checks that PRs modifying docs include a preview link in the PR description.
# It enforces documentation PR best practices for PipeCD.

name: Docs Preview Check

on:
  pull_request:
    types: [opened, edited, synchronize]
    paths:
      - 'docs/**'
      - '*.md'

permissions:
  contents: read
  pull-requests: read

jobs:
  check-preview-link:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check for Preview Link in PR Description
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          BRANCH: ${{ github.head_ref }}
        run: |
          set -e
          
          # Get PR body
          BODY=$(gh pr view "$PR_NUMBER" --json body -q '.body')
          
          # Get owner and repo name for the head repository (fork or main)
          OWNER=$(gh pr view "$PR_NUMBER" --json headRepositoryOwner -q '.headRepositoryOwner.login')
          REPO_NAME=$(gh pr view "$PR_NUMBER" --json headRepository -q '.headRepository.name')
          
          # Expected GitHub Pages URL format
          GITHUB_PAGES_URL="https://${OWNER}.github.io/${REPO_NAME}/${BRANCH}"
          
          # Check if branch starts with 'docs-'
          DOC_BRANCH_REGEX='^docs-'
          
          # Color codes for output
          GREEN=$'\033[0;32m'
          RED=$'\033[0;31m'
          YELLOW=$'\033[1;33m'
          NC=$'\033[0m' # No Color
          
          echo "Checking PR #$PR_NUMBER for docs preview link..."
          echo "Branch: $BRANCH"
          echo "Expected preview base URL: $GITHUB_PAGES_URL"
          echo ""
          
          # Check if the PR description contains a preview link
          if ! PREVIEW_LINE=$(echo "$BODY" | grep -iE '^[[:space:]]*[Pp]review.*https?://' || true); then
            # Branch doesn't start with 'docs-' - provide guidance
            if [[ ! "$BRANCH" =~ $DOC_BRANCH_REGEX ]]; then
              echo "${YELLOW}[INFO] This branch does not start with 'docs-'. For automatic preview deployment:${NC}"
              echo ""
              echo "1. Create a branch with 'docs-' prefix (e.g., docs-update-readme)"
              echo "2. Push your changes to trigger the preview deployment"
              echo "3. Add the preview link to your PR description"
              echo ""
              echo "Example PR description format:"
              echo "  Preview: https://YOUR_USERNAME.github.io/pipecd/docs-your-branch/"
              echo ""
              echo "${YELLOW}Skipping check since branch doesn't follow docs- convention.${NC}"
              exit 0
            fi
            
            echo "${RED}[ERROR] Docs PR: No preview link found in PR description.${NC}"
            echo ""
            echo "Please include a line starting with 'Preview' and a valid GitHub Pages URL."
            echo ""
            echo "Steps to add a preview:"
            echo "1. Ensure your branch name starts with 'docs-'"
            echo "2. Push your changes to trigger the preview deployment workflow"
            echo "3. Add the following to your PR description:"
            echo ""
            echo "   Preview: $GITHUB_PAGES_URL/"
            echo ""
            exit 1
          else
            # Found a preview line, check if it matches expected format
            if [[ "$PREVIEW_LINE" == *"$GITHUB_PAGES_URL"* ]]; then
              if [[ "$BRANCH" =~ $DOC_BRANCH_REGEX ]]; then
                echo "${GREEN}[OK] Docs PR: Branch starts with 'docs-' and preview link matches expected format.${NC}"
                echo "Preview URL found: $GITHUB_PAGES_URL/"
              else
                echo "${YELLOW}[WARN] Docs PR: Preview link found but branch does not start with 'docs-'.${NC}"
                echo "Consider renaming your branch to enable automatic preview deployment."
              fi
            else
              PREVIEW_URL=$(echo "$PREVIEW_LINE" | grep -oE 'https?://[^ )"'"'"']*' || true)
              echo "${YELLOW}[WARN] Docs PR: Preview link found but doesn't match expected GitHub Pages URL.${NC}"
              echo ""
              echo "Expected: $GITHUB_PAGES_URL/"
              echo "Found:    $PREVIEW_URL"
              echo ""
              echo "This might be fine if you're using a different preview method."
            fi
          fi
          
          echo ""
          echo "Check completed successfully."
